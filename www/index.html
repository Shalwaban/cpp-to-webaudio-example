<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>

    <script type="text/javascript" src="em.js"></script>
  </head>
  <body>


    <script>
var getSamples = null;

Module.onRuntimeInitialized = function() {
 




    // Import function from Emscripten generated file
    getSamples = Module.cwrap(
    'getSamples', 'number', ['number', 'number', 'number']
    );

   



    // Create example data to test float_multiply_array
    var data = new Float32Array(1000);
    for(i =0; i < 100; i++) {
      data[i] = i;//[1, 2, 3, 4, 5]);

}

    

}









var dataHeap = null;
var dataPtr = null;

var data = new Float32Array();

function au(l, r) {
    if(dataHeap == null) {
        data = new Float32Array(l.length * 2);
        // Get data byte size, allocate memory on Emscripten heap, and get pointer
        var nDataBytes = data.length * data.BYTES_PER_ELEMENT;
        dataPtr = Module._malloc(nDataBytes);

        // Copy data to Emscripten heap (directly accessed from Module.HEAPU8)
        dataHeap = new Uint8Array(Module.HEAPU8.buffer, dataPtr, nDataBytes);
        dataHeap.set(new Uint8Array(data.buffer));

        //var t0 = performance.now();
    }

    // for(i = 0; i < l.length; i++) {
    //     l[i] = r[i] = (Math.random()*2.0 - 1.0) * 0.1;
    // }

    // Call function and get result
    getSamples(dataHeap.byteOffset, l.length, 2);

    var result = new Float32Array(dataHeap.buffer, dataHeap.byteOffset, data.length);

    for(i = 0; i < l.length; i++) {
        l[i] = result[i*2];
        r[i] = result[i*2+1];
    }

    //// Free memory - we're not going to do that here. Ever.... AHAAAHAAHAHAH!!
    //Module._free(dataHeap.byteOffset);
}








var scriptNode = null;
var source = null;
var audioCtx = null;


function setupAudio(fn) {
  // Create AudioContext and buffer source
  var AudioContext = window.AudioContext // Default
    || window.webkitAudioContext // Safari and old versions of Chrome
    || false; 
    
    if (!AudioContext) {
        // Do whatever you want using the Web Audio API
        alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox");
    }
  audioCtx = new AudioContext();
  source = audioCtx.createBufferSource();

  // buff size, ins, outs
  scriptNode = audioCtx.createScriptProcessor(4096, 0, 2);

  scriptNode.onaudioprocess = function(audioProcessingEvent) {

    fn(audioProcessingEvent.outputBuffer.getChannelData(0), audioProcessingEvent.outputBuffer.getChannelData(1)); 
  };
}
var audioRunning = false;
function startAudio(fn) {
  if(audioRunning) return;
  setupAudio(fn);
  scriptNode.connect(audioCtx.destination);
  source.start();
  audioRunning = true;
}


    </script>
    <a href="javascript: startAudio(au)">start</a>
  </body>
</html>